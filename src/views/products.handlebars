
<div class="container">
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Ecommerce</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">            
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="http://localhost:8080/carts/6658f71308ecdd10b3fcb175">CART</a>
                    </li>
                </ul>
                <div class="ml-auto">
                    <div class="text-right">
                        <h4>Welcome {{user.first_name}} {{user.last_name}}</h4>
                        <h6>({{user.role}})</h6>
                        <a href="http://localhost:8080/profile" class="btn btn-primary">PROFILE</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>



    <div class="container mt-5">
    <div class="row align-items-start">
        <!-- Primera columna con Precio y Categorías -->
        <div class="col-md-3 p-4">
            <!-- Div de Precio -->
            <div>
                <h5>Price</h5>
                <label for="sortAsc">
                    <input type="radio" id="sortAsc" name="sort" class="sort-radio" value="asc" aria-label="Radio button for following text input">
                    Low to high
                </label>
                <br>
                <label for="sortDesc">
                    <input type="radio" id="sortDesc" name="sort" class="sort-radio" value="desc" aria-label="Radio button for following text input">
                    High to low
                </label>
            </div>

            <!-- Div de Categorías -->
            <div>
                {{#if categories}}
                    <div>
                        <h5>Category</h5>
                        {{#each categories}}
                            <label class="category-label" for="category-{{@index}}">
                                <input type="checkbox" id="category-{{@index}}" class="category-checkbox" data-category="{{this}}" aria-label="Checkbox for following text input">
                                <span>{{this}}</span>
                            </label>
                        {{/each}}
                        <button class="btn btn-outline-secondary m-3 p-1">
                            <a href="/products" style="text-decoration: none; color: inherit;">Reset filters</a>
                        </button>
                    </div>
                {{/if}}
            </div>
        </div>

        <!-- Segunda columna con los productos -->
        <div class="col-md-9">
            {{#if response.payload}}
                <div class="row p-2">
                    {{#each response.payload}}
                        <div class="product card p-2 m-4 col-sm-5">
                            <h5 class="card-text">{{title}}</h5>                            
                            <img src="{{thumbnail}}" class="card-img-top" alt="Product Image">
                            <a href="/product/{{_id}}" class="m-3">
                                <button class="btn-secondary" > + Details</button>
                            </a>
                            <div class="card-body">
                                <p class="card-text">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8m5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0"/>
                                    <path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195z"/>
                                    <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083q.088-.517.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1z"/>
                                    <path d="M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 6 6 0 0 1 3.13-1.567"/>
                                    </svg>
                                    Price: ${{price}}
                                </p>
                                <a href="#" class="btn btn-primary" onclick="addToCart('{{_id}}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart4" viewBox="0 0 16 16">
                                        <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"/>
                                    </svg>
                                    Add
                                </a>
                            </div>
                        </div>
                    {{/each}}
                </div>

                <!--Paginado-->
                <nav aria-label="...">
                    <ul class="pagination">
                        <li class="page-item {{#unless response.hasPrevPage}} disabled{{/unless}}">
                            <a class="page-link" href="{{response.prevLink}}">Previous</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">{{response.page}}</a></li>
                        <li class="page-item  {{#unless response.hasNextPage}} disabled{{/unless}}">
                            <a class="page-link" href="{{response.nextLink}}">Next</a>
                        </li>
                    </ul>
                </nav>
            {{else}}
                <h1 class="no-products">No hay productos para mostrar</h1>
            {{/if}}
        </div>
    </div>
</div>


<script>
    async function addToCart(pid) {
        const cid = '6658f71308ecdd10b3fcb175';
        const url = `http://localhost:8080/api/carts/${cid}/product/${pid}`;
        try {
            const response = await fetch(url, {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Product added:', data);
                alert('Product added');
            } else {
                throw new Error('Error ');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error to add product');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.category-checkbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const label = this.closest('.category-label');
                if (this.checked) {
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                }
                const category = getCategory();
                const sort = getSort();
                updateURL(category, sort);
            });
        });

        const sortRadios = document.querySelectorAll('.sort-radio');
        sortRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                const category = getCategory();
                const sort = getSort();
                updateURL(category, sort);
            });
        });

        function getCategory() {
            const checkboxes = document.querySelectorAll('.category-checkbox:checked');
            const categories = Array.from(checkboxes).map(checkbox => checkbox.getAttribute('data-category'));
            return categories.join(',');
        }

        function getSort() {
            const radios = document.querySelectorAll('.sort-radio:checked');
            return radios.length > 0 ? radios[0].value : '';
        }

        function updateURL(category, sort) {
            let query = `?limit=4&page=1`;
            if (sort) {
                query += `&sort=${sort}`;
            }
            if (category) {
                query += `&query=${category}`;
            }
            window.location.href = `/products${query}`;
        }

    });
</script>

<style>

    .card-img-top {
    max-width: 200px; 
    max-height: 200px; 
    width: auto; 
    height: auto; 
    display: block; 
    margin: 0 auto; 
    }
     .category-label {
        display: block; 
        margin-bottom: 2px; 
    }
    .category-checkbox {
        margin-right: 2px; 
    }
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
    }

    .no-products {
        font-size: 24px;
        color: #999;
        text-align: center;
        margin-top: 20px;
    }
</style>